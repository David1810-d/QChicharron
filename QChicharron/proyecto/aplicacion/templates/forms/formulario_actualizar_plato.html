{% extends 'forms/formulario_actualizacion.html' %}

{% block actu %}

<!-- Botón para abrir modal -->
<button type="button" class="btn btn-success mt-2" data-toggle="modal" data-target="#productoModalActualizar">
  Agregar Producto
</button>

<!-- Modal Actualizar -->
<div class="modal fade" id="productoModalActualizar" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Producto</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalFormContainerActualizar">
        <div class="loading">Cargando formulario...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarProductoActualizar">Agregar Producto</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  console.log("=== SCRIPT MODAL ACTUALIZAR CARGADO ===");
  
  $(document).ready(function() {

    // Cargar formulario cuando se abre el modal de actualizar
    $('#productoModalActualizar').on('show.bs.modal', function (e) {
      console.log("=== MODAL ACTUALIZAR ABRIENDO ===");
      
      const totalForms = $("input[name$='TOTAL_FORMS']");
      console.log("Total forms encontrados:", totalForms.length);
      
      if (!totalForms.length) {
        e.preventDefault();
        alert("ERROR: No se encontró el formset.");
        return;
      }

      const formIndex = totalForms.val();
      console.log("Form index:", formIndex);
      
      const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
      console.log("Empty form HTML length:", emptyFormHtml.length);
      
      if (emptyFormHtml.trim() === '') {
        e.preventDefault();
        alert("ERROR: El formset no está disponible.");
        return;
      }
      
      const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);
      $('#modalFormContainerActualizar').html(newFormHtml);
      
      // Inicializar select2 en los selects del modal
      $('#modalFormContainerActualizar select').select2({
        dropdownParent: $('#productoModalActualizar'),
        width: '100%'
      });
      
      console.log("Formulario cargado en modal actualizar");
    });

    // Agregar Producto desde modal actualizar
    $(document).on('click', '#guardarProductoActualizar', function(e) {
      e.preventDefault();
      const $modal = $('#productoModalActualizar');

      console.log("=== GUARDANDO PRODUCTO (Actualizar) ===");

      const totalForms = $("input[name$='TOTAL_FORMS']");
      const form = $(".form-container form");
      const submitButton = form.find("button[type='submit']");

      if (!totalForms.length || !form.length) {
        alert("ERROR: No se encontraron los elementos necesarios.");
        return;
      }

      const formIndex = totalForms.val();

      // Tomar valores dentro del modal
      const productoVal = $modal.find("select[name*='-producto']").val();
      const cantidadVal = $modal.find("input[name*='-cantidad']").val();
      const unidadVal   = $modal.find("input[name*='-unidad']").val();

      console.log("Valores capturados:", {productoVal, cantidadVal, unidadVal});

      if (!productoVal || !cantidadVal || !unidadVal) {
        alert("Por favor complete todos los campos");
        return;
      }

      // Crear nuevo formulario con los valores
      const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
      const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);
      const $newDiv = $('<div class="producto-form"></div>').html(newFormHtml);

      // Asignar valores
      $newDiv.find("select[name*='-producto']").val(productoVal);
      $newDiv.find("input[name*='-cantidad']").val(cantidadVal);
      $newDiv.find("input[name*='-unidad']").val(unidadVal);

      // Agregar antes del botón submit
      submitButton.before($newDiv);
      totalForms.val(parseInt(formIndex, 10) + 1);

      // Cerrar modal
      $modal.modal('hide');
      alert("¡Producto agregado exitosamente!");
      
      console.log("Producto agregado, nuevo total:", totalForms.val());
    });

    console.log("=== LISTENERS MODAL ACTUALIZAR REGISTRADOS ===");
  });
</script>
{% endblock %}