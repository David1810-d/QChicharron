{% extends 'layout.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'lib/css/forms.css' %}">
<link rel="stylesheet" href="{% static 'lib/css/custom.css' %}">

<h2>{{ titulo }}</h2>

<!-- Mensajes -->
{% if messages %}
<div id="messages-container">
    {% for message in messages %}
    <div class="message {{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- ===== FORMULARIO PRINCIPAL ===== -->
<div class="form-container">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Nombre -->
        <div class="mb-3">
            <label for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
            {{ form.nombre }}
            {% for error in form.nombre.errors %}
                <span class="error">{{ error }}</span>
            {% endfor %}
        </div>
<!-- Marca con botón -->
<div class="field-with-button">
    <div>
        <label for="{{ form.marca.id_for_label }}">{{ form.marca.label }}</label>
        {{ form.marca }}
    </div>
    <button type="button" class="create-button" onclick="abrirModal('modalMarca')">+ Nueva</button>
</div>

<!-- Categoría con botón -->
<div class="field-with-button">
    <div>
        <label for="{{ form.categoria.id_for_label }}">{{ form.categoria.label }}</label>
        {{ form.categoria }}
    </div>
    <button type="button" class="create-button" onclick="abrirModal('modalCategoria')">+ Nueva</button>
</div>

<!-- Proveedor con botón -->
<div class="field-with-button">
    <div>
        <label for="{{ form.proveedor.id_for_label }}">{{ form.proveedor.label }}</label>
        {{ form.proveedor }}
    </div>
    <button type="button" class="create-button" onclick="abrirModal('modalProveedor')">+ Nuevo</button>
</div>

<!-- Unidad con botón -->
<div class="field-with-button">
    <div>
        <label for="{{ form.unidad.id_for_label }}">{{ form.unidad.label }}</label>
        {{ form.unidad }}
    </div>
    <button type="button" class="create-button" onclick="abrirModal('modalUnidad')">+ Nueva</button>
</div>


        <!-- Tipo de uso -->
        <div class="mb-3">
            <label for="{{ form.tipo_uso.id_for_label }}">{{ form.tipo_uso.label }}</label>
            {{ form.tipo_uso }}
        </div>


        <!-- Stock -->
        <div class="mb-3">
            <label for="{{ form.stock.id_for_label }}">{{ form.stock.label }}</label>
            {{ form.stock }}
        </div>

        <button type="submit" class="btn-save">Crear Producto</button>
    </form>
</div>

<div class="back-link">
    <button type="button" onclick="window.history.back();">Volver</button>
</div>


<!-- ===== MODALES ===== -->

<!-- Modal Marca -->
<div id="modalMarca" class="simple-modal">
    <div class="modal-content">
        <h3>Nueva Marca</h3>
        <form method="post">
            {% csrf_token %}
            {{ marca_form.as_p }}
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalMarca')">Cancelar</button>
                <button type="submit" name="crear_marca" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Categoría -->
<div id="modalCategoria" class="simple-modal">
    <div class="modal-content">
        <h3>Nueva Categoría</h3>
        <form method="post">
            {% csrf_token %}
            {{ categoria_form.as_p }}
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalCategoria')">Cancelar</button>
                <button type="submit" name="crear_categoria" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Proveedor -->
<div id="modalProveedor" class="simple-modal">
    <div class="modal-content">
        <h3>Nuevo Proveedor</h3>
        <form method="post">
            {% csrf_token %}
            {{ proveedor_form.as_p }}
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalProveedor')">Cancelar</button>
                <button type="submit" name="crear_proveedor" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Unidad -->
<div id="modalUnidad" class="simple-modal">
    <div class="modal-content">
        <h3>Nueva Unidad</h3>
        <form method="post">
            {% csrf_token %}
            {{ unidad_form.as_p }}
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalUnidad')">Cancelar</button>
                <button type="submit" name="crear_unidad" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>


<!-- ===== JS PARA MODALES Y MENSAJES ===== -->
<script>
function abrirModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'block';
    modal.offsetHeight;
    modal.style.opacity = '1';
}

function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.opacity = '0';
    setTimeout(() => modal.style.display = 'none', 300);
}

// Cerrar modal al hacer clic fuera
document.querySelectorAll('.simple-modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) cerrarModal(this.id);
    });
});

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.keyCode === 27) {
        document.querySelectorAll('.simple-modal').forEach(m => {
            if (m.style.display === 'block') cerrarModal(m.id);
        });
    }
});

// Auto-ocultar mensajes
setTimeout(() => {
    document.querySelectorAll('#messages-container .message').forEach(msg => {
        msg.style.transition = 'opacity 0.5s';
        msg.style.opacity = '0';
        setTimeout(() => msg.remove(), 500);
    });
}, 5000);
</script>

{% endblock %}
