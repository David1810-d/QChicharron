{% extends 'forms/formulario_crear.html' %}

{% block extra %}

<!-- Botón para abrir modal -->
<button type="button" class="btn btn-success mt-2" data-toggle="modal" data-target="#productoModalCrear">
  Agregar Producto
</button>

<!-- Modal Crear -->
<div class="modal fade" id="productoModalCrear" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Producto</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalFormContainerCrear">
        <div class="loading">Cargando formulario...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarProductoCrear">Agregar Producto</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  console.log("=== SCRIPT DEL MODAL CARGADO ===");
  console.log("jQuery:", typeof $ !== 'undefined');
  console.log("Select2:", typeof $.fn.select2 !== 'undefined');
  
  $(document).ready(function() {

    // Cargar formulario cuando se abre el modal
    $('#productoModalCrear').on('show.bs.modal', function (e) {
      console.log("=== MODAL ABRIENDO ===");
      
      const totalForms = $("input[name$='TOTAL_FORMS']");
      console.log("Total forms encontrados:", totalForms.length);
      
      if (!totalForms.length) {
        e.preventDefault();
        alert("ERROR: No se encontró el formset.");
        return;
      }

      const formIndex = totalForms.val();
      console.log("Form index:", formIndex);
      
      const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
      console.log("Empty form HTML length:", emptyFormHtml.length);
      
      if (emptyFormHtml.trim() === '') {
        e.preventDefault();
        alert("ERROR: El formset no está disponible.");
        return;
      }
      
      const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);
      $('#modalFormContainerCrear').html(newFormHtml);
      
      // Inicializar select2 en los selects del modal
      $('#modalFormContainerCrear select').select2({
        dropdownParent: $('#productoModalCrear'),
        width: '100%'
      });
      
      console.log("Formulario cargado en modal");
    });

    // Crear Producto
    $(document).on('click', '#guardarProductoCrear', function(e) {
      e.preventDefault();
      const $modal = $('#productoModalCrear');

      console.log("=== GUARDANDO PRODUCTO ===");

      const totalForms = $("input[name$='TOTAL_FORMS']");
      const form = $(".form-container form");
      const submitButton = form.find("button[type='submit']");

      if (!totalForms.length || !form.length) {
        alert("ERROR: No se encontraron los elementos necesarios.");
        return;
      }

      const formIndex = totalForms.val();

      // Tomar valores dentro del modal
      const productoVal = $modal.find("select[name*='-producto']").val();
      const cantidadVal = $modal.find("input[name*='-cantidad']").val();
      const unidadVal   = $modal.find("input[name*='-unidad']").val();

      console.log("Valores:", {productoVal, cantidadVal, unidadVal});

      if (!productoVal || !cantidadVal || !unidadVal) {
        alert("Por favor complete todos los campos");
        return;
      }

      // Crear nuevo formulario con los valores
      const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
      const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);
      const $newDiv = $('<div class="producto-form"></div>').html(newFormHtml);

      // Asignar valores
      $newDiv.find("select[name*='-producto']").val(productoVal);
      $newDiv.find("input[name*='-cantidad']").val(cantidadVal);
      $newDiv.find("input[name*='-unidad']").val(unidadVal);

      submitButton.before($newDiv);
      totalForms.val(parseInt(formIndex, 10) + 1);

      $modal.modal('hide');
      alert("¡Producto agregado exitosamente!");
    });

    console.log("=== LISTENERS REGISTRADOS ===");
  });
</script>
{% endblock %}