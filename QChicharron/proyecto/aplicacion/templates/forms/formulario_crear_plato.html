{% extends 'forms/formulario_crear.html' %}

{% block extra %}
    <!-- Botón -->
<!-- Botón para abrir modal -->
<button type="button" class="btn btn-success mt-2" data-toggle="modal" data-target="#productoModalCrear">
  Agregar Producto
</button>

<!-- Modal Crear -->
<div class="modal fade" id="productoModalCrear" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Producto</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="modalFormContainerCrear">
        {% csrf_token %}
        {{ formset.empty_form.as_p }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarProductoCrear">Agregar Producto</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {

  // Crear Producto
  $(document).on('click', '#guardarProductoCrear', function(e) {
    e.preventDefault();
    const $modal = $('#productoModalCrear');

    console.log("=== AGREGANDO PRODUCTO (Crear) ===");

    const totalForms = $("input[name$='TOTAL_FORMS']");
    const form = $(".form-container form");
    const submitButton = form.find("button[type='submit']");

    if (!totalForms.length || !form.length) {
      alert("ERROR: No se encontraron los elementos necesarios en el formulario principal.");
      return;
    }

    const formIndex = totalForms.val();
    const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
    const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);

    const $newDiv = $('<div class="producto-form"></div>').html(newFormHtml);

    // Tomar valores dentro del modal
    const productoVal = $modal.find("select[name*='__prefix__-producto']").val();
    const cantidadVal = $modal.find("input[name*='__prefix__-cantidad']").val();
    const unidadVal   = $modal.find("input[name*='__prefix__-unidad']").val();

    if (!productoVal || !cantidadVal || !unidadVal) {
      alert("Por favor complete todos los campos");
      return;
    }

    // Asignar valores al nuevo form
    $newDiv.find("select[name*='-producto']").val(productoVal);
    $newDiv.find("input[name*='-cantidad']").val(cantidadVal);
    $newDiv.find("input[name*='-unidad']").val(unidadVal);

    submitButton.before($newDiv);
    totalForms.val(parseInt(formIndex, 10) + 1);

    // Limpiar modal
    $modal.find("select, input").val('');
    $modal.modal('hide');

    alert("¡Producto agregado exitosamente!");
  });

  // Actualizar Producto
  $(document).on('click', '#guardarProductoActualizar', function(e) {
    e.preventDefault();
    const $modal = $('#productoModalActualizar');

    console.log("=== AGREGANDO PRODUCTO (Actualizar) ===");

    const totalForms = $("input[name$='TOTAL_FORMS']");
    const form = $(".form-container form");
    const submitButton = form.find("button[type='submit']");

    if (!totalForms.length || !form.length) {
      alert("ERROR: No se encontraron los elementos necesarios en el formulario principal.");
      return;
    }

    const formIndex = totalForms.val();
    const emptyFormHtml = `{{ formset.empty_form.as_p|escapejs }}`;
    const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);

    const $newDiv = $('<div class="producto-form"></div>').html(newFormHtml);

    // Tomar valores dentro del modal
    const productoVal = $modal.find("select[name*='__prefix__-producto']").val();
    const cantidadVal = $modal.find("input[name*='__prefix__-cantidad']").val();
    const unidadVal   = $modal.find("input[name*='__prefix__-unidad']").val();

    if (!productoVal || !cantidadVal || !unidadVal) {
      alert("Por favor complete todos los campos");
      return;
    }

    // Asignar valores al nuevo form
    $newDiv.find("select[name*='-producto']").val(productoVal);
    $newDiv.find("input[name*='-cantidad']").val(cantidadVal);
    $newDiv.find("input[name*='-unidad']").val(unidadVal);

    submitButton.before($newDiv);
    totalForms.val(parseInt(formIndex, 10) + 1);

    // Limpiar modal
    $modal.find("select, input").val('');
    $modal.modal('hide');

    alert("¡Producto agregado exitosamente!");
  });

});
</script>

{% endblock %}